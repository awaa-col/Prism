# Prism 插件开发指南

## 概述

本指南为 Prism 框架插件开发者提供完整的开发规范、安全要求和最佳实践。Prism 采用三层安全架构，所有插件都必须遵守严格的安全规范。

## 安装与审核（分阶段，需管理员批准）

为了符合生产安全，插件安装走“分阶段审核”流程。管理员可能只批准部分权限，开发者必须提前告知“所需权限清单与最低集”，否则插件可能无法安装或只能以降级模式运行。

- 阶段1：发起安装（权限分析）
  - POST /api/v1/admin/plugins/install
  - 请求体：{"github_url":"https://github.com/owner/repo","name":"my_plugin"}
  - 返回：{success:true/false, stage:"permission_review", context_id, permissions:[...]}
    - permissions 是按类型与资源分析出的建议权限列表（插件 manifest 声明 + 自动分析）

- 阶段2：管理员审核并批准（可能只批准部分）
  - POST /api/v1/admin/plugins/secure/approve
  - 请求体：{"context_id":"...", "approved_permissions":[...]}
  - 注意：如果只批准“最低必要集”，插件将以“基础能力”运行；若缺失关键权限，后续安装将失败并回滚。

- 阶段3：依赖解析
  - POST /api/v1/admin/plugins/secure/resolve
  - 请求体：{"context_id":"...", "strategy":"auto|strict"}
  - 用于处理版本/冲突；不改变权限。

- 阶段4：安装（写锁文件）
  - POST /api/v1/admin/plugins/secure/install
  - 请求体：{"context_id":"..."}
  - 发生动作：复制到 plugins/{name}、创建 venv、写入权限锁文件 plugins/{name}/permissions.lock.json（系统写；插件只读）

- 阶段5：初始化
  - POST /api/v1/admin/plugins/secure/init
  - 请求体：{"context_id":"..."}
  - 清理临时目录，完成收尾。

PowerShell 快速演示（管理员 API Key 已获取）：
$resp = Invoke-RestMethod -Method POST http://localhost:8080/api/v1/admin/plugins/install -Headers @{Authorization="Bearer $ADMIN_KEY"} -ContentType 'application/json' -Body '{"github_url":"https://github.com/owner/repo","name":"my_plugin"}'
$context_id = $resp.context_id
# 审核：选择批准的权限（示例：批准最低必要集）
$approved = $resp.permissions | Where-Object { $_.type -in @("file.read_plugin","api.create_route","network.https") }
Invoke-RestMethod -Method POST http://localhost:8080/api/v1/admin/plugins/secure/approve -Headers @{Authorization="Bearer $ADMIN_KEY"} -ContentType 'application/json' -Body (@{context_id=$context_id; approved_permissions=$approved} | ConvertTo-Json)
# 解析与安装
Invoke-RestMethod -Method POST http://localhost:8080/api/v1/admin/plugins/secure/resolve -Headers @{Authorization="Bearer $ADMIN_KEY"} -ContentType 'application/json' -Body (@{context_id=$context_id; strategy="auto"} | ConvertTo-Json)
Invoke-RestMethod -Method POST http://localhost:8080/api/v1/admin/plugins/secure/install -Headers @{Authorization="Bearer $ADMIN_KEY"} -ContentType 'application/json' -Body (@{context_id=$context_id} | ConvertTo-Json)
Invoke-RestMethod -Method POST http://localhost:8080/api/v1/admin/plugins/secure/init -Headers @{Authorization="Bearer $ADMIN_KEY"} -ContentType 'application/json' -Body (@{context_id=$context_id} | ConvertTo-Json)

安装后的核查：
- 锁文件：Get-Content plugins/my_plugin/permissions.lock.json | Out-String
- 插件列表：GET /api/v1/admin/plugins
- 路由/链：GET /api/v1/admin/chains

## 权限需求清单（开发者必须提供）

用户在审核时只会批权限；开发者必须在仓库与 plugin.json 清楚标注“所需权限”与“最低必要集（Minimal set）”。建议使用如下模板：

- Minimal 必需：
  - file.read_plugin: "config.yml"（读取配置）
  - api.create_route: "/api/v1/plugins/my_plugin/*"（暴露路由）
  - network.https: "api.example.com"（外部依赖域名，示例）
- 可选增强：
  - file.write_temp: "*"（缓存临时文件）
  - system.environment: "MY_PLUGIN_API_KEY"（从环境读取密钥）
- 高危（默认不需要，强制说明风险与理由）：
  - system.subprocess: "git"（仅用于特定功能）
  - dynamic.code_exec: "*"（严禁，除非确有必要）

清单规则：
- 每项都要给出具体 resource（尽量精确，不要 "*" 滥用）
- 标注用途与影响（不批准会导致哪些功能不可用）
- 给出“降级策略”：若未批准某权限，插件如何优雅降级

示例 plugin.json 声明（与上方最小集一致）：
{
  "name": "my_plugin",
  "version": "1.0.0",
  "description": "示例插件",
  "permissions": [
    { "type": "file.read_plugin", "resource": "config.yml", "description": "读取配置" },
    { "type": "api.create_route", "resource": "/api/v1/plugins/my_plugin/*", "description": "暴露路由" },
    { "type": "network.https", "resource": "api.example.com", "description": "访问外部服务" }
  ]
}

## 部分权限批准时的行为（必须实现降级）

- 未批准 Minimal 中的任何一项：
  - 安装阶段失败，返回错误："missing_required_permissions"
  - 解决方法：调整 permissions 或在 UI/CLI 重新申请批准
- Minimal 批准，但可选未批准：
  - 安装成功，插件以“基础能力”运行
  - 插件必须在 initialize/handle 中检测权限并优雅降级（不抛未捕获异常）
- 建议实现：
  - 在 initialize 时读取锁文件（只读），将已授予权限映射到内部开关
  - 在每个需要权限的功能入口做软判断；缺失时返回一致的错误响应或禁用该子功能

示例降级代码片段：
async def initialize(self) -> None:
    # 读取锁文件（只读）
    try:
        with open("permissions.lock.json", "r", encoding="utf-8") as f:
            lock = json.load(f)
            granted = {p["type"]: p for p in lock.get("permissions", [])}
            self.features = {
                "external_call": "network.https" in granted,
                "routes": "api.create_route" in granted
            }
    except Exception:
        self.features = {"external_call": False, "routes": False}
        self.logger.warning("无法读取权限锁，默认禁用可选功能")

## 🚨 重要安全须知（更新）

- 锁文件位置：plugins/{plugin_name}/permissions.lock.json（系统写；插件只读）
- 插件可读取锁文件，但任何写入/删除/重命名都将被审计钩子阻止
- `system_secure/` 目录严格禁止访问

### 必读安全规则

1. **禁止修改权限锁文件**
   - 🚫 插件不得写入、删除、重命名 `permissions.lock.json`
   - ✅ 系统（Loader/Installer）在非插件上下文中写入该文件

2. **权限声明是强制性的**
   - ✅ 必须在 `plugin.json` 中声明所有需要的权限
   - ✅ 权限一旦写入锁文件后不可更改（插件无法修改）

3. **目录访问限制**
   - ✅ 只能访问自己的插件目录与临时目录
   - 🚫 禁止访问其他插件目录
   - 🚫 禁止访问系统敏感目录（如 `system_secure/`）

## 插件结构要求（节选）

```
plugins/your_plugin/
├── plugin.py
├── plugin.json
├── permissions.lock.json   # 仅系统写；插件只读
└── static/ / other_modules/（可选）
```

## 故障排除（与审核相关）

- 安装报错 missing_required_permissions：
  - 原因：未批准最低必要权限
  - 处理：管理员批准后重试；或开发者调整 Minimal 清单与功能降级策略
- 路由未生成：
  - 原因：缺少 api.create_route 或插件未提供 route schema
  - 处理：批准权限或移除路由功能，改为链式处理

## 总结

- 安装是分阶段的，管理员必须审核并批准权限；不再自动批准。
- 开发者必须提供“所需权限清单与最低集”，并实现“部分批准时的降级行为”。
- 安装完成后，权限锁文件位于插件根目录且只读于插件；系统代码负责写入与强制执行权限。