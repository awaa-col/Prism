# 锁文件保护机制文档

## 概述

锁文件保护机制是Prism框架三层安全架构的核心组件，确保插件无法篡改自己或其他插件的权限配置，从而维护整个系统的安全性。

## 三层安全架构

### 第一层：监狱围墙 (Prison Wall)
- **功能**：强制目录限制
- **实现**：通过审计沙箱限制插件只能访问指定目录
- **保护范围**：插件根目录 + 临时目录

### 第二层：权限锁文件 (Permission Lock Files)  
- **功能**：不可篡改的权限记录
- **位置**：`plugins/{plugin_name}/permissions.lock.json`
- **特性**：系统代码可读写；插件允许读取，但任何写入/删除/重命名都会被阻止

### 第三层：动态审计 (Dynamic Audit)
- **功能**：实时权限检查和违规阻止
- **实现**：Python审计钩子 + 权限管理器
- **覆盖**：文件操作、网络连接、系统调用等

## 锁文件保护实现

### 核心保护逻辑（摘要）

在 `app/core/audit_sandbox.py` 中实现：
- open 事件：仅对锁文件的写模式（w/a/x/+ 等）拦截，读取允许
- os.remove/os.unlink/os.rename：若目标路径命中 `permissions.lock*`，直接拦截
- system_secure 目录：任何访问一律禁止

### 保护特性

1. 写操作精确拦截：对锁文件的写/删/改均被阻止
2. 目录级保护：完全禁止访问 `system_secure` 目录
3. 目录围墙：仅允许访问插件根目录与临时目录
4. 多层防护：路径解析 + 文件名检测 + 目录访问控制 + 事件级写操作拦截

## 锁文件结构

```json
{
  "plugin_name": "example_plugin",
  "permissions": [
    {
      "type": "file.read_plugin",
      "resource": "config.yml",
      "description": "读取插件配置文件"
    },
    {
      "type": "api.create_route", 
      "resource": "/api/v1/plugins/example_plugin/*",
      "description": "创建API路由"
    }
  ],
  "created_at": "851244.2509958",
  "version": "1.0"
}
```

## 权限类型（摘要）

- 文件：file.read_plugin / file.write_plugin / file.read_temp / file.write_temp
- API：api.create_route
- 系统：system.subprocess / system.environment
- 网络：network.http / network.https / network.specific_domain
- 数据库：database.access / database.direct_import（高危）

## 安全测试（示例）

- 写/删/改锁文件：❌ 被拦截（open 写、remove/unlink、rename）
- 读锁文件：✅ 允许（仅系统读写有效；插件读取不会改变权限）
- 访问 system_secure：❌ 全禁

## 安全保证（更新）

1. 插件可以读取自身锁文件，但任何写入/删除/重命名都会被立即阻止  
2. 系统代码（Loader/Installer）可读写锁文件；此操作不在插件上下文中执行  
3. 插件无法访问 `system_secure` 目录  
4. 插件无法绕过权限系统  
5. 权限不可篡改（写禁覆盖写、删、改）

## 监控和日志

所有违规尝试都会被记录，示例：
```
[error] Plugin 'malicious_test' attempted to modify lock file via os.remove: plugins/example_chain_plugin/permissions.lock.json
[error] Plugin 'malicious_test' attempted to write lock file via open(): plugins/example_chain_plugin/permissions.lock.json
```

## 总结

锁文件保护机制通过事件级写操作拦截与目录围墙，确保了：
- 🏰 访问范围受限
- 🔒 锁文件只读（插件视角）
- 🛡️ 动态审计阻止越权

遵循该策略，插件无法提升权限或破坏他人安全。