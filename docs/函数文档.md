# Prism 函数与类文档（精简版）

说明：
- 仅记录对开发与安全审计重要的函数/类，采用「名称 + 作用 + 入参 + 出参」格式。
- 覆盖核心模块：审计沙箱、插件加载、OAuth 注册表、安全与响应工具、运行时。
- 调用链以 "->" 表示。

## 1. app/core/audit_sandbox.py

- 类：PluginContext
  - 作用：封装 ContextVar，提供 `use()` 便捷上下文设置。
  - 入参：构造(name: str, default: Any)
  - 出参：无；方法 get() -> Optional[str]，use(value: str) -> contextmanager

- 变量：current_plugin_context
  - 作用：全局插件执行上下文标记（哪个插件在运行）。
  - 入参：无
  - 出参：get() 返回当前插件名或 None

- 类：AuditHookManager
  - 作用：管理并注册 Python 审计钩子，强制沙箱权限检查。
  - 主要方法：
    - __init__(permission_manager: Optional[SandboxPermissionManager])
      - 作用：初始化并保持单例；绑定权限管理器
      - 出参：None
    - activate()
      - 作用：调用 `sys.addaudithook` 注册 `_audit_hook`，开启沙箱
      - 出参：None；可能抛 RuntimeError
    - set_plugin_root_paths(plugin_root_paths: Dict[str, str])
      - 作用：设置插件根路径映射，启用“监狱围墙”目录限制
      - 出参：None
    - _audit_hook(event: str, args: tuple[Any, ...])
      - 作用：核心审计逻辑：文件、网络、子进程、环境变量、数据库、动态执行检查；包含锁文件保护
      - 入参：event（审计事件名），args（事件参数）
      - 出参：None；越权则抛 PermissionError
    - _check_permission(plugin_name: str, event: str, perm_type: PermissionType, resource: Optional[str])
      - 作用：统一权限匹配与违规记录
      - 出参：无；越权抛 PermissionError

- 函数：get_audit_manager(permission_manager: Optional[SandboxPermissionManager]) -> AuditHookManager
  - 作用：获取审计钩子单例
  - 入参：权限管理器（可选）
  - 出参：AuditHookManager 实例

- 关键安全规则：
  - 绝对禁止访问 system_secure/ 目录与 permissions.lock.json（抛 PermissionError）
  - 非插件代码直接放行；插件代码严格按目录和权限校验
  - 事件覆盖：open/import/os.system/subprocess/socket.connect/os.getenv/sqlite3.connect/psycopg2.connect/exec/eval

## 2. app/plugins/loader.py

- 类：DependencyResolver
  - 作用：构建依赖图并拓扑排序，检测循环依赖。
  - 主要方法：
    - add_plugin(plugin_name: str, dependencies: List[str]) -> None
    - resolve_dependencies() -> List[str]（可能抛 ValueError）

- 类：SecurityValidator
  - 作用：白名单+受限权限校验；提供默认最小权限。
  - 主要方法：
    - validate_permissions(metadata: PluginMetadata) -> List[str]（返回警告列表）
    - get_default_permissions(plugin_name: str) -> List[SandboxPermission]

- 类：PluginLoader
  - 作用：异步插件加载器；读取 manifest 权限，生成锁文件，注册沙箱，装配路由。
  - 主要属性：
    - plugin_dir: 插件根目录
    - plugins: Dict[str, PluginInterface]
    - plugin_metadata: Dict[str, PluginMetadata]
    - permission_manager: SandboxPermissionManager
    - audit_manager: AuditHookManager
    - secure_dir: 权限锁目录（plugin_data/{plugin}/permissions.lock.json）
    - plugin_root_paths: 插件根目录映射（供沙箱校验）
  - 主要方法：
    - initialize() -> None
    - shutdown() -> None
    - load_plugin(plugin_name: str, allowed_domains: List[str] | None = None) -> Optional[PluginInterface]
      - 流程：签名校验 -> manifest 读取权限 -> 动态导入 -> initialize() -> 校验与写锁 -> 加载锁权限 -> 记录根路径 -> 挂载到管理器
    - load_plugin_group(plugin_name: str, allowed_domains: List[str] | None = None) -> Optional[MetaPlugin]
      - 流程：加载元插件 -> manifest 权限 -> 写锁 -> 子插件加载与依赖解析 -> 预设调用链注册
    - load_all_plugins() -> Dict[str, PluginInterface]
      - 流程：过滤 enabled -> 并发加载元数据 -> 依赖排序 -> 按序加载 -> 注入根路径到审计管理器
    - get_plugin(name: str) -> Optional[PluginInterface]
    - list_plugins() -> List[Dict[str, Any]]
    - get_plugin_metadata(name: str) -> Optional[PluginMetadata]
    - get_permission_violations(plugin_name: str) -> List[str]
    - _load_plugin_metadata(plugin_name: str) -> Optional[PluginMetadata]
      - 作用：仅读 manifest（plugin.yml/json），解析权限与依赖，避免导入第三方代码
    - _load_plugin_directly(plugin_path: Path, plugin_name: str, config: Dict[str, Any], http_client: Optional[AsyncClient]) -> Optional[PluginInterface]
      - 作用：importlib 加载插件类并实例化（不依赖插件自报 metadata）
    - _create_permission_lock_file(plugin_name: str, permissions: List[SandboxPermission]) -> None
      - 作用：写入 plugin_data/{plugin}/permissions.lock.json，不可由插件修改
    - _load_permissions_from_lock_file(plugin_name: str) -> None
      - 作用：从锁文件重建权限对象并授予到管理器
    - reload_plugin(name: str) -> bool
    - unload_plugin(name: str) -> bool
    - validate_plugin_security(plugin_name: str) -> Dict[str, Any]
    - get_all_routers() -> Dict[str, APIRouter]
      - 作用：按插件 `get_route_schema()` 动态生成路由；执行时以 current_plugin_context 标记插件身份并调用 `invoke()`

## 3. app/core/oauth_registry.py

- 类：OAuthProviderRegistry
  - 作用：扫描 app/oauth_providers 目录，加载所有 BaseOAuthProvider 子类。
  - 入参：provider_dir: str = "app/oauth_providers"
  - 出参：实例方法（典型）：get(provider_name: str) -> BaseOAuthProvider | None（推断）

- 函数：get_oauth_provider_registry() -> OAuthProviderRegistry
  - 作用：获取注册表单例

## 4. app/core/security.py（节选）

- 函数：create_access_token(data: Dict[str, Any], expires_delta: Optional[timedelta] = None) -> str
  - 作用：生成 JWT 访问令牌
  - 入参：payload 数据、过期时长
  - 出参：JWT 字符串

- 函数：decode_access_token(token: str) -> Optional[Dict[str, Any]]
  - 作用：校验并解码 JWT
  - 入参：token
  - 出参：payload 或 None

- 函数：verify_password(plain_password: str, hashed_password: str) -> bool
- 函数：get_password_hash(password: str) -> str
- 函数：create_api_key_token(api_key_id: str, user_id: str, permissions: List[str]) -> str
- 函数：verify_api_key_token(token: str) -> Optional[Dict[str, Any]]
- 函数：hash_api_key(plain_key: str) -> str
- 函数：verify_api_key_plain(plain_key: str, stored_hash_hex: str) -> bool

## 5. app/utils/responses.py

- 类：APIResponse
  - 作用：统一成功/失败响应包装
  - 典型方法：success(data: Any) -> Response 对象（或等价结构）

- 类：APIException(Exception)
  - 作用：统一异常

- 类：ResponseFormatter
  - 作用：将 RequestContext 格式化为响应体

## 6. app/core/runtime.py

- 函数：set_plugin_loader(loader: PluginLoader) -> None
- 函数：get_plugin_loader() -> Optional[PluginLoader]
- 函数：set_chain_runner(runner: ChainRunner) -> None
- 函数：get_chain_runner() -> Optional[ChainRunner]

## 7. app/plugins/subplugin_loader.py

- 类：SubPluginLoader
  - 作用：在元插件内部发现并加载子插件；解析依赖
  - 方法（节选）：load_all() -> None，resolve_dependencies() -> None

- 类：ChainRegistry
  - 作用：注册预设调用链（meta 级别）
  - 方法：register_preset_chains() -> None

## 8. app/services/auth_service.py ✨ 新增服务层

- 类：AuthService
  - 作用：封装所有与用户身份认证、令牌管理和会话相关的业务逻辑。从 API 层抽离出来，提高代码复用性和可测试性。
  - 主要方法：
    - async login_user(db: AsyncSession, username: str, password: str, user_agent: Optional[str], ip_address: Optional[str]) -> Dict[str, Any]
      - 作用：验证用户凭据，成功则创建并返回访问令牌和刷新令牌。
      - 入参：数据库会话、用户名、密码、User-Agent、IP地址
      - 出参：包含 access_token, refresh_token, token_type, expires_in 的字典
      - 调用链：db.execute(select(User)) -> verify_password() -> create_access_token() -> create_refresh_token_object() -> db.add() -> db.commit()
      - 异常：APIException (401) - 凭据无效或账户未激活
    
    - async refresh_token(db: AsyncSession, refresh_token: str, user_agent: Optional[str], ip_address: Optional[str]) -> Dict[str, Any]
      - 作用：使用有效的刷新令牌获取新的访问令牌，并实现令牌轮换（删除旧令牌，创建新令牌）。
      - 入参：数据库会话、刷新令牌、User-Agent、IP地址
      - 出参：新的令牌对（access_token 和 refresh_token）
      - 调用链：get_refresh_token_hash() -> db.execute(select(RefreshToken)) -> create_access_token() -> db.delete() -> create_refresh_token_object() -> db.add() -> db.commit()
      - 异常：APIException (401) - 刷新令牌无效、已过期或用户未激活
    
    - async logout_user(db: AsyncSession, user: User, access_token: Optional[str], refresh_token: str) -> None
      - 作用：登出用户。将访问令牌的 JTI 加入黑名单使其失效，并从数据库中删除刷新令牌。
      - 入参：数据库会话、用户对象、访问令牌（可选）、刷新令牌
      - 出参：None
      - 调用链：decode_access_token() -> revoke_token_jti() (Redis) -> get_refresh_token_hash() -> db.execute(delete(RefreshToken)) -> db.commit()
      - 说明：即使 access_token 为 None 也会删除 refresh_token

- 函数：get_auth_service() -> AuthService
  - 作用：获取 AuthService 的单例实例（依赖注入用）。
  - 入参：无
  - 出参：AuthService 实例

- 设计优势：
  - ✅ 瘦控制器：API 层 (identity.py) 只负责调用服务，不包含业务逻辑
  - ✅ 可测试性：服务层独立，易于 Mock 数据库进行单元测试
  - ✅ 可复用性：认证逻辑可被多个 API 端点复用

## 9. app/db/models/ (数据库模型) ✨ 重构后的模块化结构

**说明**：模型定义已从单个巨大的 `models.py` 文件拆分到多个文件中，位于 `app/db/models/` 目录。这次重构大幅提高了可维护性、可读性和协作友好度。

### 模块列表

- `base.py`: Base 基类 + GUID 自定义类型
- `user.py`: User, RefreshToken, AuthorizationCode, OAuth2Token
- `rbac.py`: Role, Permission + 多对多关系表 (user_roles, role_permissions)
- `api_key.py`: APIKey, UsageLog + api_key_models 关系表
- `plugin.py`: Model (AI模型), Credential (插件凭证)
- `__init__.py`: 统一导出接口

### 关键模型详解

#### User (user.py)
- **作用**: 用户主表
- **关键字段**: id (UUID), username, email, hashed_password, is_admin, is_active
- **关系**: refresh_tokens (1-N), api_keys (1-N), credentials (1-N), roles (M-N)

#### RefreshToken (user.py)
- **作用**: 刷新令牌存储，支持令牌轮换
- **关键字段**: token_hash (哈希，不存明文), expires_at, user_agent, ip_address
- **安全**: 每次刷新后删除旧令牌，创建新令牌

#### Role & Permission (rbac.py)
- **Role**: 角色定义 (如 "admin", "user")
- **Permission**: 细粒度权限 (如 "manage_plugins", "read:demo")
- **关系**: User M-N Role M-N Permission

#### APIKey (api_key.py)
- **作用**: API 密钥管理
- **关键字段**: key_hash, name, rate_limit, total_requests, allowed_models
- **关系**: user (M-1), allowed_models (M-N), usage_logs (1-N)

#### Model & Credential (plugin.py)
- **Model**: AI 模型定义 (name, plugin_name, costs, capabilities)
- **Credential**: 插件凭证存储 (encrypted_data，使用 app.core.encryption 加密)

### 拆分优势

- ✅ **可维护性** ⬆️: 每个文件 150-300 行，易于查找和修改
- ✅ **可读性** ⬆️: 结构清晰，降低认知负担
- ✅ **扩展性** ⬆️: 新增模型时无需修改其他文件
- ✅ **协作友好** ⬆️: 减少 Git 冲突
- ✅ **测试友好** ⬆️: 可针对每个模型独立测试

## 10. 常见调用链

- 插件加载（全量）：
  - PluginLoader.initialize() -> load_all_plugins()
  -> _load_plugin_metadata()*N -> DependencyResolver.resolve_dependencies()
  -> load_plugin()/load_plugin_group()
  -> _create_permission_lock_file() -> _load_permissions_from_lock_file()
  -> audit_manager.set_plugin_root_paths()

- 插件路由执行：
  - PluginLoader.get_all_routers() 生成路由
  -> 请求进入 handler -> 获取插件实例
  -> with current_plugin_context.use(plugin_name): plugin.invoke(handler, payload)
  -> 审计钩子触发：AuditHookManager._audit_hook(...)

- 用户认证（登录）：
  - API /login endpoint -> get_auth_service() -> AuthService.login_user(...)
  -> 验证密码 -> create_access_token & create_refresh_token_object
  -> 存储 RefreshToken -> 返回令牌

- 文件访问（插件代码）：
  - open(path, mode) -> AuditHookManager._audit_hook('open', ...)
  -> 锁文件/目录防护检查 -> 目录围墙检查
  -> _check_permission(... FILE_READ/WRITE_PLUGIN 或 FILE_READ/WRITE_TEMP ...)

## 11. 备注与警示

- 锁文件与 system_secure 访问：
  - 插件任何形式的访问都会被阻止（包含路径模式与字符串匹配），违规将被记录并抛 PermissionError。
- manifest 驱动的权限：
  - 实际授予的权限来自锁文件，锁文件由 Loader 生成，插件本身无权读写。